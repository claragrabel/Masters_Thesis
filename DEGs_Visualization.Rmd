---
title: "DESeq_Visualization"
author: "clagrabel"
date: "2024-03-10"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Loading the necessary packages

```{r}
#BiocManager::install("apeglm", force=TRUE)
library(apeglm)

pacman::p_load(tidyverse, DESeq2, ggVennDiagram, UpSetR, plotly, ggrepel, scico)
```

# Loading the data

```{r}
# DEG object
dds<-readRDS("./results/deseq2_dds.rds")
dds_test<-readRDS("./results/deseq2_dds_test.rds")

# The list of DEG results
res<-readRDS("./results/deseq2_results_populations.rds")
test<-readRDS("./results/deseq2_results_test.rds")
summary(res)
summary(test)

```

# Venn Diagrams

Extract DEGs lists in order to visualize overlapping regulated genes in the comparisons of interest.


```{r}
# List of DEGs

# Creating a function to extract the lists of genes repeteadly: all DEGs, up-regulated DEGs and down-regulated DEGs.

extract_degs<-function(x) {
  return(
    x %>%
      as_tibble(rownames = "gene") %>%
      filter(padj<0.05) %>%
      pull(gene)
  )
}

extract_up<-function(x) {
  return(
    x %>%
      as_tibble(rownames = "gene") %>%
      filter(padj<0.05) %>%
      filter(log2FoldChange>0) %>%
      pull(gene)
  )
}

extract_down<-function(x) {
  return(
    x %>%
      as_tibble(rownames = "gene") %>%
      filter(padj<0.05) %>%
      filter(log2FoldChange<0) %>%
      pull(gene)
  )
}

# Extracting all differentially expressed genes from all the comparisons stored in the list of DESeqResults.

all_degs<-lapply(res, FUN=extract_degs)
str(all_degs)

up_degs<-lapply(res, FUN=extract_up)
down_degs<-lapply(res, FUN=extract_down)

```


```{r eval=FALSE, include=FALSE}
#My way of doing venn diagrams

library(ggvenn)

venn_data <- list(nombre1=vector1,
                  nombre2=vector2,
                  nombre3=vector3)

venn_palette <- c("#e35023","#148733","#058dfc")

ggvenn(venn_data, columns = c("nombre1","nombre2","nombre3"),stroke_size = 0.3,
       fill_color = venn_palette, stroke_color="white", show_percentage=F,
       fill_alpha=0.6, set_name_color = venn_palette, text_size=6)
```


# Venn Diagrams

## Regulated genes in High and Low water in both Regions

It is interesting to check both up and down-regulated genes in each region in the different treatment conditions (high and low water).
This Venn Diagram would bring light over genes that are regulated in the Southern region which are not in the Central region and viceversa.


```{r}
all_degs[c("lS_hS","lC_hC")] %>%
  ggVennDiagram(edge_size = 0) +
  scale_fill_scico(palette = "batlow") + 
  ggtitle("DEGs in Southern Spain vs. DEGs in Central Spain")
```


## Regulated genes for different populations belonging to the same region

When looking at these diagrams, we expect to obtain the genes that are overlapping or not in the different populations belonging to the same region.

### Central Region

```{r}
all_degs[c("hBui_lBui","hCan_lCan", "hTur_lTur")] %>%
  ggVennDiagram(edge_size = 0) +
  scale_fill_scico(palette = "batlow") + 
  ggtitle("DEGs in the populations from Central Spain")
```


### Southern Region

```{r}
all_degs[c("hEsp_lEsp","hLla_lLla", "hJab_lJab")] %>%
  ggVennDiagram(edge_size = 0) +
  scale_fill_scico(palette = "batlow") + 
  ggtitle("DEGs in the populations from Southern Spain")
```


## Up and Down-regulated genes


```{r}
up_degs[c("lS_hS","lC_hC")] %>%
  ggVennDiagram(edge_size = 0) +
  scale_fill_scico(palette = "batlow") +
  ggtitle("Up-regulated genes South and Central")
```

```{r}
down_degs[c("lS_hS","lC_hC")] %>%
  ggVennDiagram(edge_size = 0) +
  scale_fill_scico(palette = "batlow") +
  ggtitle("Down-regulated genes South and Central")
```



# Test for all populations except Llano

## Regulated genes in High and Low water in both Regions

It is interesting to check both up and down-regulated genes in each region in the different treatment conditions (high and low water).
This Venn Diagram would bring light over genes that are regulated in the Southern region which are not in the Central region and viceversa.


```{r}
all_degs_test<-lapply(test, FUN=extract_degs)
str(all_degs_test)

up_degs_test<-lapply(test, FUN=extract_up)
down_degs_test<-lapply(test, FUN=extract_down)
```


```{r}
all_degs_test[c("test_lS_hS","test_lC_hC")] %>%
  ggVennDiagram(edge_size = 0) +
  scale_fill_scico(palette = "batlow") + 
  ggtitle("DEGs in Southern Spain vs. DEGs in Central Spain")
```

## Regulated genes for different populations belonging to the same region

When looking at these diagrams, we expect to obtain the genes that are overlapping or not in the different populations belonging to the same region.

### Central Region

```{r}
all_degs[c("hBui_lBui","hCan_lCan", "hTur_lTur")] %>%
  ggVennDiagram(edge_size = 0) +
  scale_fill_scico(palette = "batlow") + 
  ggtitle("DEGs in the populations from Central Spain")
```


### Southern Region

```{r}
all_degs[c("hEsp_lEsp","hLla_lLla", "hJab_lJab")] %>%
  ggVennDiagram(edge_size = 0) +
  scale_fill_scico(palette = "batlow") + 
  ggtitle("DEGs in the populations from Southern Spain")
```


## Up and Down-regulated genes


```{r}
up_degs_test[c("test_lS_hS","test_lC_hC")] %>%
  ggVennDiagram(edge_size = 0) +
  scale_fill_scico(palette = "batlow") +
  ggtitle("Up-regulated genes South and Central")
```

```{r}
down_degs_test[c("test_lS_hS","test_lC_hC")] %>%
  ggVennDiagram(edge_size = 0) +
  scale_fill_scico(palette = "batlow") +
  ggtitle("Down-regulated genes South and Central")
```





# Annotation file

BLASTing _Pelobates cultripes_ genes to those annotated in _Xenopus tropicalis_ to get to know their function using diamond.


